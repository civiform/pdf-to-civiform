<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Convert PDFs to CiviForms</title>
    <link href="https://fonts.googleapis.com/css2?family=Google+Sans:wght@400;500;700" rel="stylesheet">
    <link rel="stylesheet" href="/static/style.css">
    <script>
      async function uploadFile(event) {
        event.preventDefault()
        const fileInput = document.getElementById('pdfFile')
        const file = fileInput.files[0]
        if (!file) {
          alert('Please select a PDF file containing a program form.')
          return
        }

        const formData = new FormData()
        formData.append('file', file)
        formData.append(
          'modelName',
          document.getElementById('LLMModelSelect').value,
        )
        formData.append('logLevel', getLogLevel())
        formData.append('geminiApiKey', document.getElementById('geminiApiKeyInput').value || '')

        const intermediaryDetails = document.getElementById('intermediary-details')
        const intermediaryOutputTextArea = document.getElementById('intermediaryOutput')
        const civiformOutputTextArea = document.getElementById('civiformOutput')
        const civiformOutputContainer = document.getElementById('civiform-output-container')

        intermediaryOutputTextArea.value = 'Processing...'
        civiformOutputTextArea.value = 'Processing...'
        civiformOutputContainer.classList.add('show')

        try {
          const response = await fetch('/upload', {
            method: 'POST',
            body: formData,
          })

          if (!response.ok) {
            const errorData = await response.json();
            let errorText = `Error: ${response.status}`;
            if (errorData.error) {
                errorText += ` - ${errorData.error}`;
            }
            if (errorData.details) {
                errorText += `\n\nDetails:\n${errorData.details}`;
            }
            intermediaryOutputTextArea.value = "PDF processing failed. See CiviForm output area for details.";
            civiformOutputTextArea.value = errorText;
            return;
          }

          const responseData = await response.json()

          let intermediaryJsonString = "No intermediary JSON received."
          let civiformJsonString = "No CiviForm JSON received."

          if (responseData.intermediary_json) {
            try {
              intermediaryJsonString = responseData.intermediary_json;
            } catch (error) {
              console.error('Error parsing intermediary JSON:', error)
              intermediaryJsonString = 'Error parsing intermediary JSON: ' + error.message + '\n\nRaw data received:\n' + responseData.intermediary_json
            }
          } else {
            intermediaryJsonString = "No intermediary JSON generated by server.";
          }
          intermediaryOutputTextArea.value = intermediaryJsonString;

          if (responseData.civiform_json) {
             try {
                 const civiformData = JSON.parse(responseData.civiform_json)
                 civiformJsonString = JSON.stringify(civiformData, null, 2)
             } catch (error) {
                 console.error('Error parsing CiviForm JSON:', error)
                 civiformJsonString = 'Error parsing CiviForm JSON: ' + error.message + '\n\nRaw data received:\n' + responseData.civiform_json
             }
          } else {
             civiformJsonString = "No CiviForm JSON generated by server during initial processing.";
          }
          civiformOutputTextArea.value = civiformJsonString;


        } catch (error) {
            const failMsg = `Request failed: ${error}`;
            civiformOutputTextArea.value = `Processing failed: ${failMsg}`;
          }
      }

      // --- Convert intermediary json provided by user to Civiform json ---
      async function convertToCiviform() {
        const intermediaryOutputTextArea = document.getElementById('intermediaryOutput');
        const civiformOutputTextArea = document.getElementById('civiformOutput');
        const intermediaryJsonString = intermediaryOutputTextArea.value;

        if (!intermediaryJsonString || intermediaryJsonString === "Processing PDF with LLM..." || intermediaryJsonString.startsWith("PDF processing failed")) {
          alert("No valid intermediary JSON available to convert.");
          return;
        }

        let parsedIntermediaryJson;
        try {
            parsedIntermediaryJson = JSON.parse(intermediaryJsonString);
        } catch (error) {
            alert("The content in the Intermediary JSON area is not valid JSON. Please fix it before converting.\n\nError: " + error.message);
            return;
        }

        civiformOutputTextArea.value = 'Converting to CiviForm JSON...';

        try {
          const response = await fetch('/convert_to_civiform', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({ intermediary_json: intermediaryJsonString })
          });

          if (!response.ok) {
            const errorData = await response.json();
            let errorText = `Error converting: ${response.status}`;
            if (errorData.error) {
                errorText += ` - ${errorData.error}`;
            }
             if (errorData.details) {
                errorText += `\n\nDetails:\n${errorData.details}`;
            }
            civiformOutputTextArea.value = errorText;
            return;
          }

          const responseData = await response.json();
          let civiformJsonOutput = "Conversion failed: No CiviForm JSON received.";

          if (responseData.civiform_json) {
            try {
              const civiformData = JSON.parse(responseData.civiform_json);
              civiformJsonOutput = JSON.stringify(civiformData, null, 2);
            } catch (error) {
               console.error('Error parsing received CiviForm JSON:', error);
               civiformJsonOutput = 'Error parsing received CiviForm JSON: ' + error.message + '\n\nRaw data received:\n' + responseData.civiform_json;
            }
          }
          civiformOutputTextArea.value = civiformJsonOutput;

        } catch (error) {
          civiformOutputTextArea.value = `Conversion request failed: ${error}`;
        }
      }


      async function uploadDirectory(event) {
        event.preventDefault();

        const outputTextArea = document.getElementById('directoryOutput');
        const outputContainer = document.querySelector('#directory-output-container');

        outputTextArea.value = 'Processing directory... please wait';
        outputContainer.classList.add('show');

        const formData = new FormData();
        formData.append(
          'modelName',
          document.getElementById('LLMModelSelect').value,
        );
        formData.append('logLevel', getLogLevel());
        formData.append('geminiApiKey', document.getElementById('geminiApiKeyInput').value || '')

        formData.append(
          'directoryPath',
          document.getElementById('directoryPath').value,
        );

        try {
          const response = await fetch('/upload_directory', {
            method: 'POST',
            body: formData,
          });

          if (!response.ok) {
            const errorData = await response.json();
            let errorText = `Error: ${response.status}`;
            if (errorData.error) {
                errorText += ` - ${errorData.error}`;
            }
            if (errorData.details) {
                errorText += `\n\nDetails:\n${errorData.details}`;
            }
            outputTextArea.value = errorText;
            return;
          }

          const responseData = await response.json();

          if (responseData.summary) {
            const summary = responseData.summary;
            let outputText = `Directory Processing Summary:\nTotal Files: ${summary.total_files}\nSucceeded: ${summary.success_count}\nFailed: ${summary.fail_count}\n\n`;

            if (summary.file_results) {
                outputText += "Details:\n";
                for (const file in summary.file_results) {
                    outputText += `${file}: ${summary.file_results[file].success ? 'Success' : 'Fail'}`;
                    if (summary.file_results[file].error_message) {
                        outputText += ` - ${summary.file_results[file].error_message}`;
                    }
                    outputText += "\n";
                }
            } else {
                outputText += "No file details available.\n";
            }
            outputTextArea.value = outputText;
          } else {
            outputTextArea.value = 'No summary available';
          }
        } catch (error) {
          outputTextArea.value = `Request failed: ${error}`;
        }
      };

      function copyToClipboard(textAreaId) {
        const outputTextArea = document.getElementById(textAreaId);
        if (!outputTextArea) {
          console.error(`Text area with id "${textAreaId}" not found.`);
          return;
        }
        outputTextArea.select();
        document.execCommand('copy');
        if (window.getSelection) {
          window.getSelection().removeAllRanges();
        } else if (document.selection) {
          document.selection.empty();
        }
        const button = outputTextArea.nextElementSibling;
         if (button && button.tagName === 'BUTTON' && button.textContent.startsWith("Copy")) {
             const originalText = button.textContent;
             button.textContent = 'Copied!';
             setTimeout(() => { button.textContent = originalText; }, 1500);
         } else {
             alert(`Copied content from ${textAreaId} to clipboard!`);
         }
      }

      function getLogLevel() {
        const logLevelSelect = document.getElementById('logLevelSelect')
        const selectedLogLevel = logLevelSelect.value
        return selectedLogLevel
      }
    </script>
  </head>

  <body>
    <h1>Convert PDFs to CiviForms</h1>

    <div class="inline-form-group">
      <div class="form-group">
        <label for="LLMModelSelect">Gemini Model:</label>
        <select id="LLMModelSelect">
          <option value="gemini-2.0-flash" selected>gemini-2.0-flash</option>
          <option value="gemini-2.0-flash-lite">gemini-2.0-flash-lite</option>
          <option value="gemini-2.5-flash-preview-04-17">gemini-2.5-flash-preview-04-17</option>
          <option value="gemini-2.0-pro-exp">gemini-2.0-pro-exp</option>
        </select>
      </div>
      <div class="form-group">
        <label for="geminiApiKeyInput">Gemini API Key:</label>
        <input type="text" id="geminiApiKeyInput" placeholder="Leave blank to use ~/google_api_key" size="40">
      </div>
      <div class="form-group">
        <label for="logLevelSelect">Log Level:</label>
        <select id="logLevelSelect">
          <option value="INFO">INFO</option>
          <option value="DEBUG">DEBUG</option>
        </select>
      </div>
    </div>
<hr>
<h2>Convert one PDF:</h2>

    <form onsubmit="uploadFile(event)" class="form-group">
      <label for="fileInput">Upload a PDF file:</label>
      <input type="file" id="pdfFile" accept="application/pdf" required />
      <button type="submit">Convert a single PDF file</button>
    </form>

    <div class="output-container" id="intermediary-output-container">
      <details id="intermediary-details">
          <summary>Intermediary Post-Processed JSON (Click to expand):</summary>
          <textarea
            id="intermediaryOutput"
            placeholder="Intermediary JSON from post-processing step will appear here."
          ></textarea>
          <button onclick="copyToClipboard('intermediaryOutput')">Copy Intermediary JSON</button>
          <button onclick="convertToCiviform()">Convert to CiviForm JSON</button> </details>
    </div>
    <div class="output-container" id="civiform-output-container">
       <h3>CiviForm JSON:</h3>
      <textarea
        id="civiformOutput" placeholder="CiviForm JSON output will appear here."
      ></textarea>
      <button onclick="copyToClipboard('civiformOutput')">Copy CiviForm JSON</button> and then import to CiviForm using <a href='https://docs.civiform.us/user-manual/civiform-admin-guide/program-migration#importing-a-program' target="_blank" rel="noopener noreferrer">the Import Program flow.</a>
    </div>
<hr>
    <h2 class="section-spacer">Convert multiple PDFs:</h2>
    <form onsubmit="uploadDirectory(event)" class="form-group">
      <div class="inline-form-group">
        <label for="directoryPath">Server Directory Path:</label>
        <input
          type="text"
          id="directoryPath"
          name="directoryPath"
          value="~/pdf_to_civiform/uploads"
          size="50"
        />
        <button type="submit">Process Directory</button>
      </div>
    </form>

    <div class="output-container" id="directory-output-container">
      <h3>Directory Processing Summary:</h3>
      <textarea
        id="directoryOutput"
        class="output-area"
        placeholder="Directory processing summary and details will appear here."
      ></textarea>
    </div> </body>
</html>
